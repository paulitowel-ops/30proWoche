<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plant30 Ultimate V21</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        html, body { height: 100%; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .view-content { display: none; }
        .view-active { display: block; }
        .medal-locked { filter: grayscale(1); opacity: 0.1; }
        .month-btn-active { background-color: #16a34a !important; color: white !important; }
        button, input { position: relative; z-index: 10; cursor: pointer; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 font-sans">

    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col p-4">
        
        <header class="flex justify-between items-center mb-6 pt-2">
            <div>
                <h1 class="text-3xl font-black text-green-700 italic tracking-tighter">PLANT30</h1>
                <div class="flex gap-2 mt-1" id="medals">
                    <span id="m-rainbow" class="medal-locked text-xl">üåà</span>
                    <span id="m-diverse" class="medal-locked text-xl">üíé</span>
                    <span id="m-goal" class="medal-locked text-xl">üèÜ</span>
                </div>
            </div>
            <button onclick="toggleDarkMode()" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-xl shadow-sm flex items-center justify-center border border-slate-200 dark:border-slate-700">üåì</button>
        </header>

        <div class="flex-1 pb-32">
            <div id="view-home" class="view-content view-active space-y-6">
                <div class="flex gap-2">
                    <input type="text" id="foodInput" placeholder="Was hast du gegessen?" 
                           class="flex-1 p-4 rounded-2xl bg-white dark:bg-slate-900 shadow-sm border-2 border-slate-100 dark:border-slate-800 outline-none focus:border-green-500 transition-all">
                    <button onclick="addEntry()" class="bg-green-600 text-white px-6 rounded-2xl font-bold shadow-lg active:bg-green-700">Ôºã</button>
                </div>

                <div class="bg-white dark:bg-slate-900 rounded-[2rem] p-6 shadow-md border border-slate-100 dark:border-slate-800 text-center">
                    <div class="text-6xl font-black text-green-600" id="score">0</div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1" id="weekDisplay">Woche --</p>
                </div>

                <div class="bg-white dark:bg-slate-900 rounded-[2rem] p-5 shadow-sm border border-slate-100 dark:border-slate-800">
                    <div class="flex justify-between px-2 mb-4">
                        <div id="a-red" class="w-8 h-8 rounded-full bg-red-500 opacity-20 transition-all"></div>
                        <div id="a-orange" class="w-8 h-8 rounded-full bg-orange-400 opacity-20 transition-all"></div>
                        <div id="a-yellow" class="w-8 h-8 rounded-full bg-yellow-300 opacity-20 transition-all"></div>
                        <div id="a-green" class="w-8 h-8 rounded-full bg-green-500 opacity-20 transition-all"></div>
                        <div id="a-purple" class="w-8 h-8 rounded-full bg-purple-600 opacity-20 transition-all"></div>
                    </div>
                    <div id="ampelDetails" class="space-y-3 hidden border-t border-slate-100 dark:border-slate-800 pt-4"></div>
                    <button onclick="toggleDetails()" class="w-full text-[9px] font-black text-slate-400 uppercase tracking-widest pt-2">Details & Vorschl√§ge ‚ñæ</button>
                </div>

                <div class="bg-green-700 rounded-[2rem] p-6 text-white shadow-xl relative overflow-hidden">
                    <div class="relative z-10">
                        <span class="text-[9px] font-bold uppercase opacity-70">Rezept-Tipp f√ºr heute</span>
                        <h3 id="recipeTitle" class="text-xl font-black mb-2 leading-tight">--</h3>
                        <p id="recipeDesc" class="text-xs opacity-90 leading-relaxed"></p>
                    </div>
                    <div class="absolute -right-4 -bottom-4 text-7xl opacity-10">ü•ó</div>
                </div>

                <div id="foodList" class="space-y-4"></div>
            </div>

            <div id="view-season" class="view-content space-y-4">
                <h2 class="text-2xl font-black">Saisonkalender</h2>
                <div id="monthScroll" class="flex gap-2 overflow-x-auto pb-2 no-scrollbar"></div>
                <div id="seasonContent" class="bg-white dark:bg-slate-900 p-6 rounded-[2rem] shadow-md border border-slate-100"></div>
            </div>

            <div id="view-settings" class="view-content space-y-4">
                <h2 class="text-2xl font-black">Einstellungen</h2>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-[2rem] space-y-4">
                    <button onclick="resetData()" class="w-full p-4 bg-red-50 text-red-600 font-bold rounded-2xl">Daten l√∂schen</button>
                    <p class="text-[10px] text-slate-400 text-center uppercase">Plant30 Ultimate V21 - Monday-Start-Logic</p>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-slate-950/80 backdrop-blur-lg border-t border-slate-200 dark:border-slate-800 px-6 py-4 flex justify-between items-center z-[100]">
            <button onclick="switchView('home')" class="text-2xl p-2">üè†</button>
            <button onclick="switchView('season')" class="text-2xl p-2">üìÖ</button>
            <button onclick="switchView('settings')" class="text-2xl p-2">‚öôÔ∏è</button>
        </nav>
    </div>

    <script>
        const DB = {
            "Gem√ºse": ["Tomate", "Gurke", "Paprika", "Brokkoli", "Spinat", "Zucchini", "Karotte", "Zwiebel", "Knoblauch", "Aubergine", "Kohlrabi", "Fenchel", "Radieschen", "Sellerie", "Blumenkohl", "Rosenkohl", "Gr√ºnkohl", "Rotkohl", "Wei√ükohl", "Wirsing", "Spitzkohl", "Rote Bete", "Pastinake", "Hokkaido", "Butternuss", "Lauch", "Pak Choi", "Mangold", "Artischocke", "Topinambur", "Schwarzwurzel", "Meerrettich", "Spargel", "Chicor√©e", "Radicchio", "Rucola", "Feldsalat", "Eisbergsalat", "Kopfsalat", "Romanasalat", "Portulak", "Postelein", "Bambussprossen", "Okra", "Zuckerschoten", "Fr√ºhlingszwiebel", "Chinakohl", "S√º√ükartoffel", "Wasabi", "Kresse", "Meerrettich", "Wilder Brokkoli", "Ur-Karotte"],
            "Obst": ["Apfel", "Birne", "Banane", "Erdbeere", "Himbeere", "Heidelbeere", "Brombeere", "Johannisbeere", "Stachelbeere", "Zitrone", "Limette", "Orange", "Mandarine", "Clementine", "Grapefruit", "Pomelo", "Mango", "Kiwi", "Pfirsich", "Nektarine", "Aprikose", "Kirsche", "Weintraube", "Honigmelone", "Wassermelone", "Pflaume", "Ananas", "Papaya", "Avocado", "Granatapfel", "Feige", "Dattel", "Kaki", "Physalis", "Quitte", "Rhabarber", "Lychee", "Sternfrucht", "Drachenfrucht", "Maracuja", "Guave"],
            "H√ºlsenfr√ºchte": ["Linsen", "Rote Linsen", "Belugalinsen", "Kidneybohnen", "Schwarze Bohnen", "Wei√üe Bohnen", "Kichererbsen", "Erbsen", "Edamame", "Tofu", "Tempeh", "Lupinen", "Sojabohnen", "Mungbohnen"],
            "Getreide & N√ºsse": ["Hafer", "Dinkel", "Reis", "Quinoa", "Hirse", "Buchweizen", "Roggen", "Weizen", "Amaranth", "Mais", "Bulgur", "Couscous", "Gerste", "Walnuss", "Haselnuss", "Mandel", "Cashew", "Paranuss", "Pekannuss", "Pistazie", "Macadamia", "Erdnuss", "Leinsamen", "Chiasamen", "K√ºrbiskerne", "Sonnenblumenkerne", "Sesam", "Mohn", "Hanfsamen"],
            "Kr√§uter": ["Basilikum", "Petersilie", "Schnittlauch", "Dill", "Rosmarin", "Thymian", "Oregano", "Salbei", "Minze", "Koriander", "B√§rlauch", "Ingwer", "Kurkuma", "Zimt", "Chili", "Lorbeer", "Liebst√∂ckel", "Majoran"]
        };

        const SEASON_DB = {
            1: {v: ["Gr√ºnkohl", "Wirsing", "Pastinake", "Rote Bete", "Lauch", "Schwarzwurzel", "Steckr√ºbe"], o: ["Lagerapfel"]},
            2: {v: ["Rosenkohl", "Lauch", "Pastinake", "Topinambur", "Wirsing"], o: ["Lagerapfel"]},
            3: {v: ["B√§rlauch", "Spinat", "Radieschen", "Feldgurke", "Portulak"], o: ["Rhabarber"]},
            4: {v: ["Spargel", "B√§rlauch", "Spinat", "Kopfsalat", "Mangold"], o: ["Rhabarber"]},
            5: {v: ["Blumenkohl", "Kohlrabi", "Spargel", "Zucchini", "Mair√ºbe"], o: ["Erdbeeren"]},
            6: {v: ["Erbsen", "Zuckererbsen", "Brokkoli", "Gurke", "Tomate"], o: ["Kirschen", "Himbeeren", "Erdbeeren"]},
            7: {v: ["Tomate", "Paprika", "Bohnen", "Zucchini", "Aubergine", "Mais"], o: ["Heidelbeeren", "Pfirsich", "Aprikose"]},
            8: {v: ["Mais", "Aubergine", "Tomate", "Paprika", "Hokkaido", "Zwiebel"], o: ["Brombeeren", "Pflaumen", "Melone"]},
            9: {v: ["K√ºrbis", "Sellerie", "Fenchel", "Karotten", "Rote Bete"], o: ["√Ñpfel", "Birnen", "Weintrauben"]},
            10: {v: ["K√ºrbis", "Rote Bete", "Pastinake", "Rosenkohl", "Meerrettich"], o: ["Quitten", "Esskastanien", "√Ñpfel"]},
            11: {v: ["Gr√ºnkohl", "Rotkohl", "Wirsing", "Schwarzwurzel", "Lauch"], o: ["Lagerapfel"]},
            12: {v: ["Gr√ºnkohl", "Pastinake", "Rote Bete", "Wirsing"], o: ["Lagerapfel"]}
        };

        const COLORS = {
            red: { n: "Rot", c: "bg-red-500", t: ["Tomate", "Rote Bete", "Erdbeere"] },
            orange: { n: "Orange", c: "bg-orange-400", t: ["Karotte", "K√ºrbis", "S√º√ükartoffel"] },
            yellow: { n: "Gelb", c: "bg-yellow-300", t: ["Mais", "Gelbe Paprika", "Banane"] },
            green: { n: "Gr√ºn", c: "bg-green-500", t: ["Spinat", "Brokkoli", "Kr√§uter"] },
            purple: { n: "Lila", c: "bg-purple-600", t: ["Aubergine", "Rotkohl", "Heidelbeere"] }
        };

        let state = {
            items: [], history: [], darkMode: false, lastWeek: "", showDetails: false, lastMilestone: 0
        };

        function load() {
            try {
                const saved = localStorage.getItem('plant30_v21');
                if(saved) state = JSON.parse(saved);
                
                const now = new Date();
                const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                const currentWeek = d.getUTCFullYear() + "-W" + weekNo;

                if(state.lastWeek !== currentWeek) {
                    if(state.items && state.items.length > 0) state.history.push({w: state.lastWeek, c: state.items.length});
                    state.items = [];
                    state.lastWeek = currentWeek;
                    state.lastMilestone = 0;
                    save();
                }
            } catch(e) { console.error("Error loading data"); }
            render();
        }

        function save() { localStorage.setItem('plant30_v21', JSON.stringify(state)); }

        function switchView(id) {
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('view-active'));
            document.getElementById('view-' + id).classList.add('view-active');
            if(id === 'season') renderSeason(new Date().getMonth() + 1);
        }

        function toggleDarkMode() { state.darkMode = !state.darkMode; save(); render(); }
        function toggleDetails() { state.showDetails = !state.showDetails; render(); }

        function addEntry(manualVal = null) {
            const input = document.getElementById('foodInput');
            const val = manualVal || input.value;
            if(!val) return;

            val.split(/[,;]/).forEach(v => {
                const name = v.trim();
                if(!name) return;
                const clean = name.toLowerCase();
                let category = "Sonstiges";
                let displayName = name.charAt(0).toUpperCase() + name.slice(1);

                for(let cat in DB) {
                    if(DB[cat].some(f => f.toLowerCase() === clean)) {
                        category = cat;
                        displayName = DB[cat].find(f => f.toLowerCase() === clean);
                        break;
                    }
                }

                if(!state.items.find(i => i.n === displayName)) {
                    state.items.push({n: displayName, c: category, col: getCol(displayName)});
                }
            });
            input.value = ""; save(); render();
        }

        function getCol(n) {
            n = n.toLowerCase();
            if(/tomate|erdbeer|rote|kirsch|radies|apfel/.test(n)) return 'red';
            if(/karotte|k√ºrbis|orange|mango|s√º√ü/.test(n)) return 'orange';
            if(/zitron|gelb|mais|banane/.test(n)) return 'yellow';
            if(/brokkoli|spinat|lauch|gurke|salat|gr√ºn/.test(n)) return 'green';
            if(/heidel|brom|aubergine|lila|rotkohl/.test(n)) return 'purple';
            return null;
        }

        function renderSeason(m) {
            const months = ["Jan", "Feb", "M√§r", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"];
            document.getElementById('monthScroll').innerHTML = months.map((name, i) => `
                <button onclick="renderSeason(${i+1})" class="px-5 py-2 rounded-xl text-xs font-black uppercase ${m === i+1 ? 'month-btn-active' : 'bg-white dark:bg-slate-800'}">${name}</button>
            `).join('');
            
            const data = SEASON_DB[m];
            document.getElementById('seasonContent').innerHTML = `
                <h3 class="text-xl font-black mb-4">${months[m-1]}</h3>
                <div class="space-y-4">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Gem√ºse</p>
                    <div class="flex flex-wrap gap-2">${data.v.map(x => `<span class="bg-green-50 dark:bg-green-900/30 text-green-700 px-3 py-1 rounded-lg text-xs font-bold">${x}</span>`).join('')}</div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase pt-2">Obst</p>
                    <div class="flex flex-wrap gap-2">${data.o.map(x => `<span class="bg-orange-50 dark:bg-orange-900/30 text-orange-700 px-3 py-1 rounded-lg text-xs font-bold">${x}</span>`).join('')}</div>
                </div>`;
        }

        function updateRecipe() {
            const colors = [...new Set(state.items.map(i => i.col).filter(c => c))];
            const missing = Object.keys(COLORS).find(c => !colors.includes(c));
            const tips = {
                red: { t: "Rote-Bete-Carpaccio", d: "D√ºnne Scheiben Rote Bete mit Apfel, Waln√ºssen und etwas Meerrettich-Dressing." },
                orange: { t: "Goldene Karotten-Suppe", d: "Karotten mit frischem Ingwer und einem Schuss Kokosmilch cremig p√ºrieren." },
                yellow: { t: "Mais-Paprika-Salsa", d: "Maisk√∂rner, gelbe Paprika und Zwiebeln kurz anbraten und mit Limette verfeinern." },
                green: { t: "B√§rlauch-Spinat-Pesto", d: "Frischen Spinat und Kr√§uter mit Pinienkernen und Oliven√∂l zu Pasta mixen." },
                purple: { t: "Gebackene Brombeer-Aubergine", d: "Aubergine im Ofen r√∂sten und mit Brombeeren und Ziegenk√§se toppen." },
                none: { t: "Bunter Regenbogen-Salat", d: "Kombiniere alles, was du noch im K√ºhlschrank hast!" }
            };
            const pick = tips[missing] || tips.none;
            document.getElementById('recipeTitle').innerText = pick.t;
            document.getElementById('recipeDesc').innerText = pick.d;
        }

        function render() {
            document.documentElement.classList.toggle('dark', state.darkMode);
            const score = state.items.length;

            // KONFETTI LOGIK
            const milestone = Math.floor(score / 10) * 10;
            if (milestone > state.lastMilestone && milestone > 0) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#16a34a', '#fbbf24', '#ffffff']
                });
                state.lastMilestone = milestone;
                save();
            }
            if (score < state.lastMilestone) {
                state.lastMilestone = Math.floor(score / 10) * 10;
            }

            document.getElementById('score').innerText = score;
            document.getElementById('weekDisplay').innerText = "Woche " + (state.lastWeek || "--");

            const colsFound = [...new Set(state.items.map(i => i.col).filter(c => c))];
            document.getElementById('m-rainbow').classList.toggle('medal-locked', colsFound.length < 5);
            document.getElementById('m-goal').classList.toggle('medal-locked', score < 30);
            
            const details = document.getElementById('ampelDetails');
            details.innerHTML = "";
            details.classList.toggle('hidden', !state.showDetails);
            
            Object.keys(COLORS).forEach(c => {
                const activeColor = colsFound.includes(c);
                document.getElementById('a-' + c).style.opacity = activeColor ? "1" : "0.15";
                
                if(state.showDetails) {
                    // Filtert die Vorschlagsliste: Zeige nur Elemente, die NICHT in state.items sind
                    const suggestions = COLORS[c].t.filter(sug => !state.items.some(item => item.n === sug));
                    
                    details.innerHTML += `
                        <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl">
                            <span class="text-[10px] font-black uppercase text-slate-500">${COLORS[c].n} ${activeColor ? '‚úì' : ''}</span>
                            <div class="flex gap-1">
                                ${suggestions.map(t => `<button onclick="addEntry('${t}')" class="bg-white dark:bg-slate-700 text-[9px] font-bold px-2 py-1 rounded-lg border border-slate-200">Ôºã ${t}</button>`).join('')}
                            </div>
                        </div>`;
                }
            });

            const grouped = {};
            state.items.forEach(i => (grouped[i.c] = grouped[i.c] || []).push(i));
            let html = "";
            Object.keys(grouped).sort().forEach(cat => {
                html += `<div class="text-[10px] font-black text-slate-400 uppercase px-2 mb-2 mt-4">${cat}</div><div class="flex flex-wrap gap-2 px-1">`;
                grouped[cat].forEach(item => {
                    html += `<div class="bg-white dark:bg-slate-900 pl-3 pr-1 py-1.5 rounded-xl border border-slate-100 flex items-center gap-2 shadow-sm">
                        <span class="text-xs font-bold">${item.n}</span>
                        <button onclick="removeEntry('${item.n}')" class="text-red-400 p-1">‚úï</button>
                    </div>`;
                });
                html += `</div>`;
            });
            document.getElementById('foodList').innerHTML = html;
            updateRecipe();
        }

        function removeEntry(n) { state.items = state.items.filter(i => i.n !== n); save(); render(); }
        function resetData() { if(confirm("Alles l√∂schen?")) { localStorage.clear(); location.reload(); } }

        window.onload = load;
    </script>
</body>
</html>
