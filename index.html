<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plant30 Ultimate V11</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        .dark { background-color: #0b0f1a; color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .category-header { font-size: 0.7rem; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase; color: #94a3b8; margin: 1.5rem 0 0.5rem 0.5rem; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .dark .glass { background: rgba(30, 41, 59, 0.8); }
    </style>
</head>
<body class="p-4 pb-32 min-h-screen bg-slate-50 dark:bg-slate-900 transition-colors duration-300 font-sans">

    <div class="max-w-md mx-auto">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-black text-green-700 dark:text-green-400 leading-none">PLANT30</h1>
                <p id="currentWeekDisplay" class="text-[10px] font-bold opacity-50 uppercase mt-1"></p>
            </div>
            <div id="rainbowArea" onclick="explainRainbow()" class="flex gap-1 p-2 bg-white dark:bg-slate-800 rounded-2xl shadow-sm cursor-help">
                <div class="w-3 h-3 rounded-full bg-red-500 opacity-20" id="dot-red"></div>
                <div class="w-3 h-3 rounded-full bg-orange-500 opacity-20" id="dot-orange"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-400 opacity-20" id="dot-yellow"></div>
                <div class="w-3 h-3 rounded-full bg-green-500 opacity-20" id="dot-green"></div>
                <div class="w-3 h-3 rounded-full bg-purple-500 opacity-20" id="dot-purple"></div>
            </div>
        </header>

        <main>
            <div id="mainView" class="space-y-6">
                <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] p-8 shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                    <div class="text-7xl font-black mb-1" id="score">0</div>
                    <p id="milestoneHint" class="text-[10px] text-green-600 font-bold uppercase tracking-wider"></p>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="foodInput" placeholder="Apfel, Linse, Walnuss..." class="flex-1 p-4 rounded-2xl bg-white dark:bg-slate-800 shadow-inner outline-none dark:text-white border-none">
                    <button onclick="addFoodUI()" class="bg-green-600 text-white px-6 rounded-2xl font-bold active:scale-90 transition">Ôºã</button>
                </div>

                <div id="foodList"></div>
            </div>

            <div id="historyView" class="hidden space-y-4">
                <h2 class="text-xl font-black mb-4">Vergangene Wochen</h2>
                <div id="historyContainer" class="space-y-3"></div>
            </div>

            <div id="recipeView" class="hidden space-y-6">
                <div class="bg-amber-50 dark:bg-amber-900/20 p-5 rounded-3xl border border-amber-100 dark:border-amber-800">
                    <h3 class="text-sm font-bold text-amber-800 dark:text-amber-400 mb-2 uppercase tracking-tight">Aktuell Saison in üá©üá™</h3>
                    <div id="seasonalGrid" class="flex flex-wrap gap-2"></div>
                </div>
                <h2 class="text-xl font-black">Rezept-Ideen</h2>
                <div id="recipeContainer" class="space-y-4"></div>
            </div>

            <div id="settingsView" class="hidden space-y-6">
                <h2 class="text-xl font-black">Konfiguration</h2>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] shadow-sm space-y-6">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-sm">Design Modus</span>
                        <button onclick="toggleDarkMode()" id="themeBtn" class="px-4 py-2 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm font-bold">Hell / Dunkel</button>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Meilensteine (Kommasepariert)</label>
                        <input type="text" id="milestoneInput" onchange="updateMilestones(this.value)" class="w-full p-3 bg-slate-50 dark:bg-slate-700 rounded-xl outline-none border-none text-sm">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Ausschl√ºsse (No-Gos)</label>
                        <div id="noGoList" class="flex flex-wrap gap-2 mb-3"></div>
                        <input type="text" id="noGoInput" onkeydown="if(event.key==='Enter') addNoGo()" placeholder="Was magst du nicht?" class="w-full p-3 bg-slate-50 dark:bg-slate-700 rounded-xl outline-none text-sm">
                    </div>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 glass border border-slate-200 dark:border-slate-700 rounded-full px-6 py-3 flex gap-8 shadow-2xl z-50">
            <button onclick="nav('main')" class="text-xl" title="Home">üè†</button>
            <button onclick="nav('history')" class="text-xl" title="History">üìä</button>
            <button onclick="nav('recipe')" class="text-xl" title="Rezepte">üç≥</button>
            <button onclick="nav('settings')" class="text-xl" title="Settings">‚öôÔ∏è</button>
        </nav>
    </div>

    <script>
        // DATABASE & SEASONAL DATA
        const FOOD_DB = {
            "Gem√ºse": ["Tomate", "Gurke", "Paprika", "Brokkoli", "Spinat", "Zucchini", "Karotte", "Zwiebel", "Knoblauch", "Wirsing", "Aubergine", "Salat", "Spargel", "Kohlrabi", "Fenchel", "Radieschen", "Sellerie", "Blumenkohl", "Rosenkohl", "Rotkohl", "Wei√ükohl", "Gr√ºnkohl", "Mangold", "Rote Bete", "Pastinake", "K√ºrbis", "Lauch", "Pak Choi"],
            "Obst": ["Apfel", "Birne", "Banane", "Erdbeere", "Himbeere", "Heidelbeere", "Zitrone", "Orange", "Mango", "Kiwi", "Pfirsich", "Kirsche", "Weintraube", "Melone", "Pflaume", "Ananas", "Aprikose", "Granatapfel", "Avocado"],
            "H√ºlsenfr√ºchte": ["Linse", "Bohne", "Kichererbse", "Erbse", "Sojabohne", "Tofu", "Tempeh", "Lupine", "Edamame"],
            "N√ºsse/Samen": ["Walnuss", "Mandel", "Haselnuss", "Cashew", "Leinsamen", "Chia", "K√ºrbiskerne", "Sesam", "Sonnenblumenkerne", "Hanfsamen", "Erdnuss"],
            "Getreide": ["Hafer", "Dinkel", "Reis", "Quinoa", "Hirse", "Buchweizen", "Roggen", "Weizen", "Bulgur", "Amaranth", "Mais"],
            "Kr√§uter/Pilze": ["Champignon", "Pfifferling", "Steinpilz", "Basilikum", "Petersilie", "Ingwer", "Kurkuma", "Dill", "Schnittlauch"]
        };

        const SEASONS = {
            1: ["Gr√ºnkohl", "Wirsing", "Rote Bete", "Pastinake", "Apfel"],
            2: ["Rosenkohl", "Lauch", "Pastinake", "Feldsalat", "Apfel"],
            3: ["B√§rlauch", "Spinat", "Champignons", "Rhabarber"],
            4: ["Spargel", "Spinat", "Radieschen", "Kopfsalat"],
            5: ["Erdbeere", "Spargel", "Blumenkohl", "Kohlrabi"],
            6: ["Kirsche", "Himbeere", "Zucchini", "Gurke", "Erbse"],
            7: ["Heidelbeere", "Tomate", "Paprika", "Bohne"],
            8: ["Brombeere", "Pfirsich", "Aubergine", "Mais"],
            9: ["K√ºrbis", "Pflaume", "Apfel", "Birne"],
            10: ["K√ºrbis", "Kohl", "Fenchel", "Esskastanie"],
            11: ["Wirsing", "Schwarzwurzel", "Quitte"],
            12: ["Gr√ºnkohl", "Rotkohl", "Pastinake"]
        };

        const COLOR_MAP = {
            red: ["tomate", "apfel", "erdbeere", "rote bete"],
            orange: ["karotte", "k√ºrbis", "orange", "mango"],
            yellow: ["banane", "mais", "zitron", "ananas"],
            green: ["brokkoli", "spinat", "gurke", "lauch", "salat"],
            purple: ["heidelbeere", "aubergine", "brombeere", "rotkohl"]
        };

        let state = JSON.parse(localStorage.getItem('plant30_v11')) || {
            items: [],
            history: [],
            noGos: [],
            milestones: [10, 20, 30],
            darkMode: false,
            lastWeekId: ""
        };

        function getWeekId() {
            const now = new Date();
            const onejan = new Date(now.getFullYear(), 0, 1);
            const week = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            return `${now.getFullYear()}-W${week}`;
        }

        // AUTO-RESET ON MONDAY
        if (state.lastWeekId !== getWeekId()) {
            if (state.items.length > 0) {
                state.history.unshift({ id: state.lastWeekId, count: state.items.length, items: [...state.items] });
            }
            state.items = [];
            state.lastWeekId = getWeekId();
            save();
        }

        function nav(id) {
            ['main', 'history', 'recipe', 'settings'].forEach(v => document.getElementById(v + 'View').classList.add('hidden'));
            document.getElementById(id + 'View').classList.remove('hidden');
            if(id === 'history') renderHistory();
            if(id === 'recipe') renderRecipes();
        }

        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            save(); render();
        }

        function updateMilestones(val) {
            state.milestones = val.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            save(); render();
        }

        function getLevenshtein(a, b) {
            const m = [];
            for (let i = 0; i <= b.length; i++) m[i] = [i];
            for (let j = 0; j <= a.length; j++) m[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    m[i][j] = b.charAt(i-1) === a.charAt(j-1) ? m[i-1][j-1] : Math.min(m[i-1][j-1]+1, m[i][j-1]+1, m[i-1][j]+1);
                }
            }
            return m[b.length][a.length];
        }

        function autoCorrect(input) {
            let best = { word: input, dist: 99, cat: "Sonstiges" };
            const clean = input.toLowerCase().trim();
            for (let cat in FOOD_DB) {
                for (let master of FOOD_DB[cat]) {
                    const d = getLevenshtein(clean, master.toLowerCase());
                    if (d < best.dist && d <= 2) best = { word: master, dist: d, cat: cat };
                }
            }
            return best;
        }

        function addFoodUI() {
            const input = document.getElementById('foodInput');
            const parts = input.value.split(/[,;]/);
            parts.forEach(p => {
                const res = autoCorrect(p.trim());
                if(res.word && !state.items.find(i => i.name === res.word)) {
                    let col = null;
                    for(let c in COLOR_MAP) if(COLOR_MAP[c].some(k => res.word.toLowerCase().includes(k))) col = c;
                    state.items.push({ name: res.word, cat: res.cat, color: col });
                }
            });
            if(state.milestones.includes(state.items.length)) confetti({ particleCount: 150, spread: 70 });
            input.value = ""; save(); render();
        }

        function renderHistory() {
            const container = document.getElementById('historyContainer');
            container.innerHTML = state.history.map(h => `
                <div class="bg-white dark:bg-slate-800 p-5 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-black text-sm">${h.id}</span>
                        <span class="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-3 py-1 rounded-full text-xs font-bold">${h.count} Pflanzen</span>
                    </div>
                    <p class="text-[10px] opacity-50 leading-relaxed">${h.items.map(i => i.name).sort().join(', ')}</p>
                </div>
            `).join('') || '<p class="text-center opacity-50 text-sm py-10">Noch keine Historie verf√ºgbar.</p>';
        }

        function renderRecipes() {
            const month = new Date().getMonth() + 1;
            const seasonal = SEASONS[month];
            document.getElementById('seasonalGrid').innerHTML = seasonal.map(s => `
                <span class="bg-amber-100 dark:bg-amber-900/40 text-amber-800 dark:text-amber-300 px-3 py-1.5 rounded-xl text-xs font-bold">${s}</span>
            `).join('');

            const suggestions = seasonal.filter(s => !state.items.some(i => i.name === s) && !state.noGos.includes(s));
            document.getElementById('recipeContainer').innerHTML = suggestions.slice(0, 3).map(s => `
                <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] shadow-sm border-l-8 border-green-500">
                    <h4 class="font-black mb-1">${s}-Pfanne</h4>
                    <p class="text-xs opacity-60 mb-3">Erh√∂he deine Vielfalt! Kombiniere ${s} mit etwas Oliven√∂l und N√ºssen.</p>
                    <button onclick="directAdd('${s}')" class="text-[10px] font-bold uppercase text-green-600">Ôºã Zur Liste hinzuf√ºgen</button>
                </div>
            `).join('');
        }

        function directAdd(name) { document.getElementById('foodInput').value = name; addFoodUI(); nav('main'); }

        function addNoGo() {
            const i = document.getElementById('noGoInput');
            if(i.value && !state.noGos.includes(i.value)) {
                state.noGos.push(i.value);
                i.value = ""; save(); render();
            }
        }

        function render() {
            document.documentElement.classList.toggle('dark', state.darkMode);
            document.getElementById('score').innerText = state.items.length;
            document.getElementById('currentWeekDisplay').innerText = state.lastWeekId;
            document.getElementById('milestoneInput').value = state.milestones.join(', ');
            
            const next = state.milestones.find(m => m > state.items.length);
            document.getElementById('milestoneHint').innerText = next ? `Noch ${next - state.items.length} bis zum Ziel` : "Wochenziel erreicht! üèÜ";

            const grouped = {};
            state.items.forEach(i => { (grouped[i.cat] = grouped[i.cat] || []).push(i); });
            
            let html = "";
            Object.keys(grouped).sort().forEach(cat => {
                html += `<div class="category-header">${cat}</div><div class="flex flex-wrap gap-2">`;
                grouped[cat].sort((a,b) => a.name.localeCompare(b.name)).forEach(item => {
                    html += `
                        <div class="bg-white dark:bg-slate-800 pl-4 pr-2 py-2 rounded-2xl shadow-sm border dark:border-slate-700 flex items-center gap-2">
                            <span class="text-sm font-medium">${item.name}</span>
                            <button onclick="deleteItem('${item.name}')" class="text-red-400 p-1">‚úï</button>
                        </div>`;
                });
                html += `</div>`;
            });
            document.getElementById('foodList').innerHTML = html;

            const activeColors = state.items.map(i => i.color);
            ['red', 'orange', 'yellow', 'green', 'purple'].forEach(c => {
                document.getElementById('dot-' + c).style.opacity = activeColors.includes(c) ? "1" : "0.1";
            });

            document.getElementById('noGoList').innerHTML = state.noGos.map(n => `
                <span onclick="state.noGos=state.noGos.filter(x=>x!=='${n}');save();render()" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold cursor-pointer">‚úï ${n}</span>
            `).join('');
        }

        function deleteItem(n) { state.items = state.items.filter(i => i.name !== n); save(); render(); }
        function save() { localStorage.setItem('plant30_v11', JSON.stringify(state)); }
        function explainRainbow() { alert("Dein Regenbogen-Score: Jede Farbe repr√§sentiert andere Vitamine und Stoffe. Iss bunt!"); }

        render();
    </script>
</body>
</html>